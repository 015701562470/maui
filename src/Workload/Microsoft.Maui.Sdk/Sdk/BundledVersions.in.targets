<Project>

  <PropertyGroup>
    <MauiWorkloadVersion>@VERSION@</MauiWorkloadVersion>
    <MauiWorkloadTargetFramework>@TFM@</MauiWorkloadTargetFramework>
    <MauiVersion Condition=" '$(MauiVersion)' == '' ">$(MauiWorkloadVersion)</MauiVersion>

    <!-- All the packaging type logic can be ignored with <MauiIgnoreWorkloadPackagingType>true</MauiIgnoreWorkloadPackagingType> -->
    <_MauiPackagingTypeIsWorkload>false</_MauiPackagingTypeIsWorkload>
    <_MauiPackagingTypeIsNuGetPackages>true</_MauiPackagingTypeIsNuGetPackages>

    <!-- 
      Indicates that the Microsoft.Maui.Controls.Compatibility package should be implicitly
      referenced.  This will eventually switch to false by default and become opt, in,
      however Visual Studio currently depends on this assembly being loaded for Live Visual Tree.
    -->
    <UseMauiCompat Condition=" '$(UseMauiCompat)' == '' and '$(UseMaui)' == 'true' ">true</UseMauiCompat>
  </PropertyGroup>

  <!--
    This part sets up properties for "compatibility" with workload-based builds of .NET MAUI.
  -->
  <PropertyGroup Condition="'$(MauiIgnoreWorkloadPackagingType)' != 'true' and $([MSBuild]::VersionGreaterThan($(MauiVersion), '7.0.0')) and $([MSBuild]::VersionLessThanOrEquals($(MauiVersion), '@LAST_WORKLOAD_VERSION@'))">
    <!-- $(_MauiPlatformName) is used as RIDs as well as a suffix to targeting pack names -->
    <_MauiPlatformName Condition=" '$(TargetPlatformIdentifier)' == 'windows' ">win</_MauiPlatformName>
    <_MauiPlatformName Condition=" '$(TargetPlatformIdentifier)' != 'windows' ">$(TargetPlatformIdentifier.ToLowerInvariant())</_MauiPlatformName>
    <_MauiPlatformName Condition=" '$(_MauiPlatformName)' == '' ">any</_MauiPlatformName>
    <_MauiRuntimePackAlwaysCopyLocal Condition=" '$(_MauiPlatformName)' == 'any' ">true</_MauiRuntimePackAlwaysCopyLocal>
    <_MauiPackagingTypeIsWorkload>true</_MauiPackagingTypeIsWorkload>
    <_MauiPackagingTypeIsNuGetPackages>false</_MauiPackagingTypeIsNuGetPackages>
  </PropertyGroup>

  <!--
    If we are using a workload-based builds of .NET MAUI, then make sure we list the frameworks we are using.
  -->
  <ItemGroup Condition="$(_MauiPackagingTypeIsWorkload)">
    <KnownFrameworkReference
        Condition=" '$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true' "
        Include="Microsoft.Maui.Core"
        TargetFramework="$(MauiWorkloadTargetFramework)"
        RuntimeFrameworkName="Microsoft.Maui.Core"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackName="Microsoft.Maui.Core.Ref.$(_MauiPlatformName)"
        TargetingPackVersion="$(MauiVersion)"
        RuntimePackNamePatterns="Microsoft.Maui.Core.Runtime.**RID**"
        RuntimePackRuntimeIdentifiers="$(_MauiPlatformName)"
        Profile="$(TargetPlatformIdentifier)"
        RuntimePackAlwaysCopyLocal="$(_MauiRuntimePackAlwaysCopyLocal)"
    />
    <KnownFrameworkReference
        Condition=" '$(UseMaui)' == 'true' "
        Include="Microsoft.Maui.Controls"
        TargetFramework="$(MauiWorkloadTargetFramework)"
        RuntimeFrameworkName="Microsoft.Maui.Controls"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackName="Microsoft.Maui.Controls.Ref.$(_MauiPlatformName)"
        TargetingPackVersion="$(MauiVersion)"
        RuntimePackNamePatterns="Microsoft.Maui.Controls.Runtime.**RID**"
        RuntimePackRuntimeIdentifiers="$(_MauiPlatformName)"
        Profile="$(TargetPlatformIdentifier)"
        RuntimePackAlwaysCopyLocal="$(_MauiRuntimePackAlwaysCopyLocal)"
    />
    <KnownFrameworkReference
        Condition=" '$(UseMaui)' == 'true' or '$(UseMauiEssentials)' == 'true' "
        Include="Microsoft.Maui.Essentials"
        TargetFramework="$(MauiWorkloadTargetFramework)"
        RuntimeFrameworkName="Microsoft.Maui.Essentials"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackName="Microsoft.Maui.Essentials.Ref.$(_MauiPlatformName)"
        TargetingPackVersion="$(MauiVersion)"
        RuntimePackNamePatterns="Microsoft.Maui.Essentials.Runtime.**RID**"
        RuntimePackRuntimeIdentifiers="$(_MauiPlatformName)"
        Profile="$(TargetPlatformIdentifier)"
        RuntimePackAlwaysCopyLocal="$(_MauiRuntimePackAlwaysCopyLocal)"
    />
  </ItemGroup>
  <ItemGroup Condition="'$(DisableImplicitFrameworkReferences)' != 'true' and $(_MauiPackagingTypeIsWorkload)">
    <FrameworkReference
        Condition=" '$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true' "
        Include="Microsoft.Maui.Core"
        IsImplicitlyDefined="true"
        Pack="false"
        PrivateAssets="All"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackVersion="$(MauiVersion)"
    />
    <FrameworkReference
        Condition=" '$(UseMaui)' == 'true' "
        Include="Microsoft.Maui.Controls"
        IsImplicitlyDefined="true"
        Pack="false"
        PrivateAssets="All"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackVersion="$(MauiVersion)"
    />
    <FrameworkReference
        Condition=" '$(UseMaui)' == 'true' or '$(UseMauiEssentials)' == 'true' "
        Include="Microsoft.Maui.Essentials"
        IsImplicitlyDefined="true"
        Pack="false"
        PrivateAssets="All"
        DefaultRuntimeFrameworkVersion="$(MauiVersion)"
        LatestRuntimeFrameworkVersion="$(MauiVersion)"
        TargetingPackVersion="$(MauiVersion)"
    />
  </ItemGroup>

  <!--
    These implicit <PackageReference/> pull dependencies from NuGet transitively.
    They are first added to the <_MauiImplicitPackageReference/> item group to list the the desired
    packages. Then the packages that were specified by the user are removed from the list. Finally,
    the remaining implicit packages are added into the project.

    This logic only installs packages if and only if $(UseMauiNuGets) is not true. This property
    allows the user to totally override all the default nugets installed. This should not be needed
    as the $(MauiVersion) should be sufficient. However, there may be a case to test various CI builds
    of .NET MAUI. One exception the this is that the <_MauiRequiredImplicitPackageReference/> item
    group is always installed as this is not maui dependencies but rather .NET support dependencies.
  -->
  <!-- This section is for NuGet-based builds of .NET MAUI -->
  <ItemGroup Condition=" '$(UseMauiAssets)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Resizetizer" Version="$(MauiVersion)" PrivateAssets="all" />
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMauiEssentials)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Essentials" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMauiCore)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Core" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMaui)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Controls" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMaui)' == 'true' and '$(UseMauiCompat)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Controls.Compatibility" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMaui)' == 'true' and '$(UsingMicrosoftNETSdkRazor)' == 'true' and $(_MauiPackagingTypeIsNuGetPackages) ">
    <_MauiImplicitPackageReference Include="Microsoft.AspNetCore.Components.WebView.Maui" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <!-- This section is for workload-based builds of .NET MAUI -->
  <ItemGroup Condition=" ('$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true' or '$(UseMauiAssets)' == 'true') and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Resizetizer" Version="$(MauiWorkloadVersion)" PrivateAssets="all" />
  </ItemGroup>
  <ItemGroup Condition=" ('$(UseMaui)' == 'true' or '$(UseMauiCore)') == 'true' and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Core.Build.Tasks" Version="$(MauiWorkloadVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMaui)' == 'true' and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Controls.Build.Tasks" Version="$(MauiWorkloadVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" '$(UseMaui)' == 'true' and '$(UsingMicrosoftNETSdkRazor)' == 'true' and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.AspNetCore.Components.WebView.Maui" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" ('$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true' or '$(UseMauiEssentials)' == 'true') and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Graphics" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' and '$(AndroidApplication)' != 'true' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" ('$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true' or '$(UseMauiEssentials)' == 'true') and ('$(TargetPlatformIdentifier)' == 'tizen') and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Graphics.Skia" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>
  <ItemGroup Condition=" ('$(UseMaui)' == 'true' or '$(UseMauiCore)' == 'true') and ('$(TargetPlatformIdentifier)' == 'windows') and $(_MauiPackagingTypeIsWorkload) ">
    <_MauiImplicitPackageReference Include="Microsoft.Maui.Graphics.Win2D.WinUI.Desktop" Version="$(MauiVersion)">
      <PrivateAssets Condition=" '$(OutputType)' == 'Library' ">all</PrivateAssets>
    </_MauiImplicitPackageReference>
  </ItemGroup>

  <!-- Always install the required dependecies, such as build tools for the SDK itself -->
  <ItemGroup>
    <_MauiRequiredImplicitPackageReference Remove="@(PackageReference)" />
    <PackageReference Include="@(_MauiRequiredImplicitPackageReference)" />
  </ItemGroup>
  <!-- Install the nuget packages if we are supposed to -->
  <ItemGroup Condition=" '$(UseMauiNuGets)' != 'true' ">
    <_MauiImplicitPackageReference Remove="@(PackageReference)" />
    <PackageReference Include="@(_MauiImplicitPackageReference)" />
  </ItemGroup>

</Project>